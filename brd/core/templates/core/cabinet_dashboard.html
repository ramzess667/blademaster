{% extends 'base.html' %}

{% block extra_head %}
<style>
  .bm-kabinet-top{
    display:flex;flex-direction:column;gap:12px
  }
  @media (min-width:768px){
    .bm-kabinet-top{flex-direction:row;justify-content:space-between;align-items:center}
  }

  .bm-tabs{
    display:flex;gap:10px;flex-wrap:wrap;justify-content:center
  }
  @media (min-width:768px){
    .bm-tabs{justify-content:flex-start}
  }

  .bm-tab{
    border:1px solid rgba(255,215,0,0.65);
    color:var(--gold);
    background:transparent;
    border-radius:999px;
    padding:.55rem 1rem;
    font-weight:800;
    transition:all .2s ease;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:.5rem;
  }
  .bm-tab:hover, .bm-tab.is-active{
    background:var(--gold);
    color:#000;
  }

  .bm-date-card{overflow:hidden}
  .bm-date-head{
    display:flex;justify-content:space-between;align-items:center;gap:12px;
    padding:14px 18px;
    border-bottom:1px solid rgba(255,255,255,0.10);
    background:linear-gradient(180deg, rgba(255,255,255,0.05), transparent);
  }
  .bm-date-title{font-weight:900;color:var(--gold);margin:0}
  .bm-date-sub{color:var(--text-muted);font-size:.9rem;margin-left:8px;font-weight:600}

  .bm-chip{
    display:inline-flex;align-items:center;border-radius:999px;
    padding:.32rem .75rem;
    border:1px solid rgba(255,215,0,0.45);
    background:rgba(255,215,0,0.10);
    color:var(--gold);
    font-weight:800;
    font-size:.9rem;
    white-space:nowrap;
  }

  .bm-app-row{
    padding:18px;
    border-bottom:1px solid rgba(255,255,255,0.08);
    transition:background .2s ease;
  }
  .bm-app-row:last-child{border-bottom:none}
  .bm-app-row:hover{background:rgba(255,215,0,0.06)}

  .bm-time{font-size:2rem;font-weight:900;color:var(--gold);line-height:1}
  .bm-status-pill{
    display:inline-flex;align-items:center;border-radius:999px;
    padding:.25rem .65rem;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.05);
    color:var(--text-muted);
    font-weight:800;
    font-size:.86rem;
    white-space:nowrap;
  }
  .bm-status-pill.is-new{
    border-color:rgba(255,215,0,0.35);
    color:var(--gold);
    background:rgba(255,215,0,0.08);
  }
  .bm-status-pill.is-cancelled{
    border-color:rgba(220,53,69,0.35);
    color:#ff9aa4;
    background:rgba(220,53,69,0.08);
  }
  .bm-status-pill.is-completed{
    border-color:rgba(25,135,84,0.40);
    color:#7ad9a6;
    background:rgba(25,135,84,0.10);
  }

  .bm-service-line{display:flex;justify-content:space-between;gap:12px;padding:4px 0}
  .bm-total{
    margin-top:8px;padding-top:10px;
    border-top:1px solid rgba(255,255,255,0.10);
    font-weight:900;color:var(--gold);
  }

  .bm-actions{display:grid;gap:10px}
  @media(min-width:768px){.bm-actions{justify-items:end}}
  .bm-actions .btn{width:100%}
  @media(min-width:768px){.bm-actions .btn{width:auto;min-width:170px}}

  .bm-muted-small{color:var(--text-muted);font-size:.92rem}
</style>
{% endblock %}

{% block content %}

<section class="bm-page-title">
  <div class="container" data-aos="fade-down">
    <div class="bm-kabinet-top">
      <div>
        <h1 class="display-6 fw-bold text-gold mb-1">Мои записи</h1>
        <div class="bm-muted-small">Телефон: {{ user.username }}</div>
      </div>

      <div class="d-flex gap-2">
        <a href="{% url 'cabinet_logout' %}" class="btn btn-outline-gold px-4 py-2 fw-bold rounded-pill">Выйти</a>
      </div>
    </div>

    {# Фильтры #}
    {% with tab=request.GET.tab|default:"upcoming" %}
    <div class="bm-tabs mt-4">
      <a class="bm-tab {% if tab == 'upcoming' %}is-active{% endif %}" href="?tab=upcoming">Предстоящие</a>
      <a class="bm-tab {% if tab == 'past' %}is-active{% endif %}" href="?tab=past">Прошедшие</a>
      <a class="bm-tab {% if tab == 'cancelled' %}is-active{% endif %}" href="?tab=cancelled">Отменённые</a>
      <a class="bm-tab {% if tab == 'all' %}is-active{% endif %}" href="?tab=all">Все</a>
    </div>
    {% endwith %}
  </div>
</section>

<section class="bm-section pt-4">
  <div class="container">

    {% if appointments %}
      {% regroup appointments by date as appointments_by_date %}

      {% for date_group in appointments_by_date %}
        <div class="bm-card bm-date-card mb-4">

          <div class="bm-date-head">
            <div class="d-flex align-items-baseline flex-wrap">
              <h5 class="bm-date-title">{{ date_group.grouper|date:"d E Y" }}</h5>
              <span class="bm-date-sub">
                {% with c=date_group.list|length %}
                  ({{ c }} {% if c == 1 %}запись{% else %}записей{% endif %})
                {% endwith %}
              </span>
            </div>

            <div class="d-flex gap-2 align-items-center">
              {% if date_group.grouper == today %}
                <span class="bm-chip">Сегодня</span>
              {% elif date_group.grouper == tomorrow %}
                <span class="bm-chip">Завтра</span>
              {% endif %}
            </div>
          </div>

          <div>
            {% for app in date_group.list %}
              <div class="bm-app-row">
                <div class="row g-4 align-items-start">

                  <div class="col-12 col-md-8">
                    <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 mb-3">
                      <div class="bm-time">{{ app.time|time:"H:i" }}</div>

                      {# Статус: без дублей "Новая" #}
                      <div class="d-flex flex-wrap gap-2 align-items-center">
                        {% if app.status == 'new' %}
                          <span class="bm-status-pill is-new">Новая</span>
                        {% elif app.status == 'cancelled' %}
                          <span class="bm-status-pill is-cancelled">{{ app.get_status_display }}</span>
                        {% elif app.status == 'completed' %}
                          <span class="bm-status-pill is-completed">{{ app.get_status_display }}</span>
                        {% else %}
                          <span class="bm-status-pill">{{ app.get_status_display }}</span>
                        {% endif %}
                      </div>
                    </div>

                    <div class="text-light mb-2">
                      <span class="text-muted">Мастер:</span>
                      <span class="fw-bold">{{ app.master.full_name }}</span>
                    </div>

                    <div class="bm-detail-box">
                      <div class="text-gold fw-bold mb-2">Услуги</div>

                      {% for service in app.service.all %}
                        <div class="bm-service-line">
                          <span class="text-light">{{ service.name }}</span>
                          <span class="text-gold fw-bold">{{ service.price }} ₸</span>
                        </div>
                      {% endfor %}

                      <div class="bm-total d-flex justify-content-between">
                        <span>Итого</span>
                        <span>{{ app.total_price }} ₸</span>
                      </div>

                      {% if app.prepayment_amount and app.prepayment_amount|floatformat:0 != "0" %}
                        <div class="mt-3 d-flex flex-wrap gap-2">
                          <span class="bm-status-pill is-new">Предоплата: {{ app.prepayment_amount }} ₸</span>
                          {% if app.prepayment_paid %}
                            <span class="bm-status-pill is-completed">Оплачено (имитация)</span>
                          {% else %}
                            <span class="bm-status-pill">Не оплачено</span>
                          {% endif %}
                        </div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="col-12 col-md-4">
                    <div class="bm-actions">

                      {# 4) Повторить #}
                      <a href="/services/?master={{ app.master.id }}"
                         class="btn btn-outline-gold rounded-pill fw-bold">
                        Повторить
                      </a>

                      {% if app.can_cancel %}
                        <a href="{% url 'cabinet_cancel' app.id %}"
                           class="btn btn-outline-danger rounded-pill fw-bold"
                           onclick="return confirm('Отменить запись? Это нельзя будет вернуть.')">
                          Отменить
                        </a>
                      {% endif %}

                      {% if app.status != 'cancelled' %}
                        <a href="{% url 'book_success' app.id %}"
                           class="btn btn-outline-gold rounded-pill fw-bold">
                          Детали и PDF
                        </a>
                      {% endif %}

                    </div>
                  </div>

                </div>
              </div>
            {% endfor %}
          </div>

        </div>
      {% endfor %}

    {% else %}
      <div class="text-center py-5">
        <h3 class="text-muted mb-2">У вас пока нет записей</h3>
        <p class="text-muted mb-4">Запишитесь на услугу и выберите удобное время</p>
        <a href="/services/" class="btn btn-outline-gold btn-lg px-5 py-3 fw-bold rounded-pill shadow-lg">
          Записаться
        </a>
      </div>
    {% endif %}

    <div class="text-center mt-5">
      <a href="/services/" class="btn btn-outline-gold btn-lg px-5 py-3 fw-bold rounded-pill me-0 me-md-3 mb-3 mb-md-0">
        Записаться снова
      </a>
      <a href="/" class="btn btn-outline-gold btn-lg px-5 py-3 fw-bold rounded-pill">
        На главную
      </a>
    </div>

  </div>
</section>

{% endblock %}
