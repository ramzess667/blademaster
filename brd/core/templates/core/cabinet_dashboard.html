{% extends 'base.html' %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Мои записи</h2>
        <div>
            <small class="text-muted">Телефон: {{ phone }}</small>
            <a href="{% url 'cabinet_logout' %}" class="btn btn-outline-secondary btn-sm ms-3">Выйти</a>
        </div>
    </div>

    {% if appointments %}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Дата и время</th>
                    <th>Мастер</th>
                    <th>Услуги</th>
                    <th>Сумма</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for app in appointments %}
                <tr {% if app.status not in 'cancelled,no_show' %}style="cursor: pointer;"
                    onclick="window.location='{% url 'book_success' app.id %}';" {% endif %}>
                    <td>{{ app.date|date:"d.m.Y" }}<br><small>{{ app.time|time:"H:i" }}</small></td>
                    <td>{{ app.master.full_name }}</td>
                    <td>
                        {% for service in app.service.all %}
                        {{ service.name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </td>
                    <td><strong>{{ app.total_price }} ₸</strong></td>
                    <td>
                        {% if app.status == 'new' %}<span class="badge bg-warning">Новая</span>
                        {% elif app.status == 'confirmed' %}<span class="badge bg-info">Подтверждена</span>
                        {% elif app.status == 'completed' %}<span class="badge bg-success">Выполнена</span>
                        {% elif app.status == 'cancelled' %}<span class="badge bg-danger">Отменена</span>
                        {% elif app.status == 'no_show' %}<span class="badge bg-secondary">Не явился</span>
                        {% endif %}
                    </td>
                    <td onclick="event.stopPropagation();">
                        {% if app.status in 'new,confirmed' %}
                        {% with app_datetime=app.date|date:"Y-m-d"|add:" "|add:app.time|time:"H:i"|date:"Y-m-d H:i" %}
                        {% with cancel_limit="now"|date:"Y-m-d H:i"|add:"2:00"|date:"Y-m-d H:i" %}
                        {% if cancel_limit < app_datetime %} <a href="{% url 'cabinet_cancel' app.id %}"
                            class="btn btn-sm btn-outline-danger" onclick="return confirm('Отменить запись?')">
                            Отменить</a>
                            {% else %}
                            <small class="text-muted">Отмена невозможна</small>
                            {% endif %}
                            {% endwith %}
                            {% endwith %}
                            {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-5">
        <p class="text-muted fs-4">У вас пока нет записей</p>
        <a href="/services/" class="btn btn-success btn-lg mt-4 px-5">Записаться сейчас</a>
    </div>
    {% endif %}

    <div class="text-center mt-5">
        <a href="/services/" class="btn btn-success btn-lg px-5 me-3">Записаться снова</a>
        <a href="/" class="btn btn-outline-primary btn-lg">На главную</a>
    </div>
</div>
{% endblock %}