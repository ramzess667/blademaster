{% extends 'base.html' %}

{% block extra_head %}
<style>
  /* –ß—Ç–æ–±—ã fixed-bottom –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª –∫–æ–Ω—Ç–µ–Ω—Ç */
  .bm-has-actionbar { padding-bottom: 110px; }

  /* –ü—Ä–æ–≥—Ä–µ—Å—Å */
  .bm-progress {
    height: 10px;
    border-radius: 999px;
    background: rgba(255,255,255,0.10);
    overflow: hidden;
  }
  .bm-progress > div {
    height: 100%;
    width: 66%;
    background: linear-gradient(90deg, rgba(255,215,0,0.95), rgba(212,175,55,0.85));
  }

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ –º–∞—Å—Ç–µ—Ä–∞ */
  .bm-master-card {
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.08);
    transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    position: relative;
  }
  .bm-master-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 16px 40px rgba(0,0,0,0.45);
  }

  /* –í—ã–±—Ä–∞–Ω–Ω—ã–π –º–∞—Å—Ç–µ—Ä */
  .bm-master-card.selected {
    border-color: rgba(255,215,0,0.70) !important;
    box-shadow: 0 18px 46px rgba(255,215,0,0.10), 0 18px 46px rgba(0,0,0,0.55);
    background: rgba(255,215,0,0.04);
  }

  /* –ö—Ä—É–≥–ª—ã–π –∞–≤–∞—Ç–∞—Ä */
  .bm-avatar-wrap {
    width: 120px;
    height: 120px;
    border-radius: 999px;
    overflow: hidden;
    border: 3px solid rgba(255,215,0,0.75);
    box-shadow: 0 12px 30px rgba(0,0,0,0.45);
    margin: 0 auto;
    background: #111;
  }
  .bm-avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: 50% 25%;
    display: block;
  }

  /* –ó–≤—ë–∑–¥—ã */
  .bm-stars {
    font-size: 1.25rem;
    letter-spacing: 1px;
    line-height: 1;
  }

  /* –†–∞–¥–∏–æ –¥–µ–ª–∞–µ–º ‚Äú—Å–∫—Ä—ã—Ç—ã–º‚Äù, –≤—ã–±–æ—Ä –∏–¥—ë—Ç –ø–æ –∫–ª–∏–∫—É –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ */
  .bm-radio {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  /* –ü–∏–ª—é–ª–∏ —Å–≤–æ–¥–∫–∏ */
  .bm-pill {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    padding: .35rem .75rem;
    border-radius: 999px;
    border: 1px solid rgba(255,215,0,0.45);
    background: rgba(255,215,0,0.08);
    color: var(--gold);
    font-weight: 800;
    font-size: .95rem;
  }

  /* –°–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ */
  .bm-summary-list .list-group-item {
    background: transparent !important;
    border-color: rgba(255,255,255,0.10) !important;
    color: var(--text-primary) !important;
  }

  /* –¢–µ–∫—Å—Ç "–≤—ã–±—Ä–∞–Ω" */
  .bm-selected-tag {
    display: none;
    margin-top: .75rem;
    font-weight: 800;
    color: var(--gold);
  }
  .bm-master-card.selected .bm-selected-tag {
    display: block;
  }

  /* –ù–∞ –º–æ–±–∏–ª–∫–µ –∞–≤–∞—Ç–∞—Ä —á—É—Ç—å –º–µ–Ω—å—à–µ */
  @media (max-width: 768px) {
    .bm-avatar-wrap { width: 110px; height: 110px; }
  }

  .fixed-bottom { z-index: 1000; }
</style>
{% endblock %}

{% block content %}

<div class="bm-has-actionbar">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <section class="bm-page-title">
    <div class="container" data-aos="fade-down">
      <div class="d-flex flex-column gap-2 align-items-center">
        <h1 class="display-6 fw-bold text-gold mb-0">–í—ã–±–æ—Ä –º–∞—Å—Ç–µ—Ä–∞</h1>
        <p class="lead text-muted mb-0">–®–∞–≥ 2 –∏–∑ 3 ‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞ –¥–ª—è –≤–∞—à–µ–π –∑–∞–ø–∏—Å–∏</p>
        <div class="bm-progress w-100" style="max-width: 680px;">
          <div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- –°–≤–æ–¥–∫–∞ —É—Å–ª—É–≥ -->
  <section class="bm-section pt-4">
    <div class="container" data-aos="fade-up">
      <div class="bm-card mx-auto" style="max-width: 820px;">
        <div class="p-4 p-md-5">

          <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-3">
            <div>
              <div class="text-gold fw-bold fs-4">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</div>
              <div class="text-muted">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º –º–∞—Å—Ç–µ—Ä–∞</div>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <span class="bm-pill">üßæ {{ total_price }} ‚Ç∏</span>
              <span class="bm-pill">‚è± {{ total_duration }} –º–∏–Ω</span>
              <span class="bm-pill">üìå {{ services|length }} —É—Å–ª—É–≥(–∏)</span>
            </div>
          </div>

          <ul class="list-group list-group-flush bm-summary-list mb-0">
            {% for service in services %}
              <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                <span class="text-light fw-bold">{{ service.name }}</span>
                <span class="text-gold fw-bold">{{ service.price }} ‚Ç∏ <span class="text-muted fw-normal">({{ service.duration }} –º–∏–Ω)</span></span>
              </li>
            {% endfor %}
          </ul>

        </div>
      </div>
    </div>
  </section>

  <!-- –í—ã–±–æ—Ä –º–∞—Å—Ç–µ—Ä–∞ -->
  <section class="bm-section pt-0">
    <div class="container">
      <div class="text-center mb-4" data-aos="fade-up">
        <h2 class="fw-bold text-gold mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Å—Ç–µ—Ä–∞</h2>
        <p class="text-muted mb-0">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –º–∞—Å—Ç–µ—Ä–∞, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</p>
      </div>

      <form method="post" action="{% url 'book_datetime_multi' %}" id="masterForm">
        {% csrf_token %}

        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —É—Å–ª—É–≥ -->
        {% for service in services %}
          <input type="hidden" name="services" value="{{ service.id }}">
        {% endfor %}

        <div class="row g-4">
          {% for master in masters %}
          <div class="col-12 col-md-6 col-lg-4"
               data-aos="zoom-in"
               data-aos-delay="{% cycle '100' '200' '300' '100' %}">

            <div class="bm-card bm-master-card h-100 p-4 text-center" data-master-card="{{ master.id }}">
              <!-- radio (—Å–∫—Ä—ã—Ç), –Ω–æ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ñ–æ—Ä–º–µ -->
              <input class="bm-radio" type="radio" name="master" value="{{ master.id }}" id="master{{ master.id }}" required>

              <!-- –§–æ—Ç–æ -->
              <div class="bm-avatar-wrap mb-3">
                {% if master.photo %}
                  <img src="{{ master.photo.url }}" class="bm-avatar" alt="{{ master.full_name }}" loading="lazy">
                {% else %}
                  <img src="https://via.placeholder.com/240/1E1E1E/FFD700?text={{ master.full_name|slice:":1" }}"
                       class="bm-avatar" alt="{{ master.full_name }}" loading="lazy">
                {% endif %}
              </div>

              <!-- –ò–º—è -->
              <h5 class="fw-bold fs-4 text-gold mb-2">{{ master.full_name }}</h5>

              <!-- –†–µ–π—Ç–∏–Ω–≥ -->
              {% if master.reviews_count > 0 %}
                <div class="mb-3">
                  <span class="bm-stars">
                    {% for i in "12345" %}
                      <span class="{% if forloop.counter <= master.average_rating|floatformat:0 %}text-gold{% else %}text-muted{% endif %}">‚òÖ</span>
                    {% endfor %}
                  </span>
                  <span class="text-muted ms-2">({{ master.average_rating|floatformat:1 }})</span>
                </div>
              {% else %}
                <p class="text-muted mb-3">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</p>
              {% endif %}

              <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
              <p class="text-muted mb-3">
                {{ master.description|default:"–û–ø—ã—Ç–Ω—ã–π –º–∞—Å—Ç–µ—Ä —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º"|truncatewords:18 }}
              </p>

              <div class="bm-selected-tag">‚úÖ –í—ã–±—Ä–∞–Ω–æ</div>

              <!-- –ö–Ω–æ–ø–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞) -->
              <button type="button" class="btn btn-outline-gold w-100 rounded-pill fw-bold mt-auto">
                –í—ã–±—Ä–∞—Ç—å
              </button>
            </div>

          </div>
          {% empty %}
          <div class="col-12 text-center py-5">
            <p class="text-muted fs-5">–ú–∞—Å—Ç–µ—Ä–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
          </div>
          {% endfor %}
        </div>

        <!-- –ú–æ–± –±–∞—Ä -->
        <div class="fixed-bottom d-md-none bg-dark border-top border-secondary py-3 px-4 shadow-lg"
             id="mobileActionBar" style="display:none;">
          <div class="container-fluid">
            <div class="d-flex align-items-center justify-content-center">
              <button type="submit" class="btn btn-outline-gold btn-lg px-5 fw-bold rounded-pill"
                      disabled id="submitBtnMobile">
                –î–∞–ª–µ–µ ‚Üí –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
              </button>
            </div>
          </div>
        </div>

        <!-- –î–µ—Å–∫—Ç–æ–ø –∫–Ω–æ–ø–∫–∞ -->
        <div class="text-center mt-5 pt-3 d-none d-md-block" id="desktopSubmit">
          <button type="submit" class="btn btn-outline-gold btn-lg px-5 py-3 fw-bold rounded-pill shadow-lg"
                  disabled id="submitBtnDesktop">
            –î–∞–ª–µ–µ ‚Üí –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
          </button>
        </div>

      </form>
    </div>
  </section>

</div>

<script>
  const cards = document.querySelectorAll('[data-master-card]');
  const radios = document.querySelectorAll('input[name="master"]');

  const submitBtnDesktop = document.getElementById('submitBtnDesktop');
  const submitBtnMobile = document.getElementById('submitBtnMobile');
  const mobileBar = document.getElementById('mobileActionBar');

  function updateUI() {
    const selected = Array.from(radios).some(r => r.checked);
    submitBtnDesktop.disabled = !selected;
    submitBtnMobile.disabled = !selected;
    mobileBar.style.display = selected ? 'block' : 'none';
  }

  function clearSelectedCards() {
    cards.forEach(c => c.classList.remove('selected'));
  }

  cards.forEach(card => {
    card.addEventListener('click', (e) => {
      // –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ/–∫–Ω–æ–ø–∫–µ –≤–Ω—É—Ç—Ä–∏ ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –≤—ã–±–µ—Ä–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
      const id = card.getAttribute('data-master-card');
      const radio = document.getElementById(`master${id}`);
      if (!radio) return;

      radio.checked = true;
      clearSelectedCards();
      card.classList.add('selected');

      updateUI();

      // –Ω–∞ –º–æ–±–∏–ª–∫–µ –ø—Ä–∏—è—Ç–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –Ω–∏–∂–Ω—é—é –∫–Ω–æ–ø–∫—É –ø–æ—è–≤–ª–µ–Ω–∏–µ–º
      if (window.innerWidth < 768) {
        mobileBar?.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }
    });
  });

  // –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –≤—ã–±—Ä–∞–ª —Ä–∞–¥–∏–æ (–Ω–∞ –≤—Å—è–∫–∏–π)
  radios.forEach(r => {
    r.addEventListener('change', () => {
      clearSelectedCards();
      const id = r.value;
      const card = document.querySelector(`[data-master-card="${id}"]`);
      if (card) card.classList.add('selected');
      updateUI();
    });
  });

  // init
  updateUI();
</script>

{% endblock %}
