{% extends 'base.html' %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  /* Safe space –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –Ω–∞ –º–æ–±–∏–ª–∫–µ */
  .bm-has-actionbar { padding-bottom: 110px; }

  /* –ß–∏–ø—ã –≤—Ä–µ–º–µ–Ω–∏ */
  .bm-time-btn {
    min-width: 92px;
    border-radius: 999px;
    font-weight: 800;
    transition: all .2s ease;
  }
  .bm-time-btn.active {
    background: var(--gold);
    border-color: var(--gold);
    color: #000;
  }

  /* –ù–∞ –º–æ–±–∏–ª–∫–µ: –æ–¥–∏–Ω —Ä—è–¥ —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º (–∫–æ–º–ø–∞–∫—Ç–Ω–æ) */
  @media (max-width: 768px) {
    #timeButtons {
      flex-wrap: nowrap !important;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 6px;
      justify-content: flex-start !important;
    }

    #timeButtons::-webkit-scrollbar { height: 6px; }
    #timeButtons::-webkit-scrollbar-thumb {
      background: rgba(255,215,0,0.25);
      border-radius: 10px;
    }

    .bm-time-btn {
      flex: 0 0 auto;
      width: auto;
      min-width: 92px;
    }
  }

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–≤–æ–¥–∫–∏ */
  .bm-summary-list .list-group-item {
    background: transparent !important;
    border-color: rgba(255,255,255,0.10) !important;
    color: var(--text-primary) !important;
  }

  /* –ü–∏–ª—é–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π */
  .bm-selected-pill {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    padding: .35rem .75rem;
    border-radius: 999px;
    border: 1px solid rgba(255,215,0,0.45);
    background: rgba(255,215,0,0.08);
    color: var(--gold);
    font-weight: 800;
    font-size: .95rem;
  }
</style>
{% endblock %}

{% block content %}

<div class="bm-has-actionbar">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <section class="bm-page-title">
    <div class="container" data-aos="fade-down">
      <h1 class="display-5 fw-bold text-gold mb-3">–í—ã–±–æ—Ä –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏</h1>
      <p class="lead text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø–∏—Å–∏</p>
    </div>
  </section>

  <!-- –°–≤–æ–¥–∫–∞ -->
  <section class="bm-section pt-4">
    <div class="container" data-aos="fade-up">
      <div class="bm-card mx-auto" style="max-width: 820px;">
        <div class="p-4 p-md-5">

          <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mb-3">
            <div>
              <div class="text-gold fw-bold fs-4">–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏</div>
              <div class="text-muted">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º</div>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <span class="bm-selected-pill">üë§ {{ master.full_name }}</span>
              <span class="bm-selected-pill">üßæ <span id="pillTotal">{{ total_price }}</span> ‚Ç∏</span>
              <span class="bm-selected-pill">‚è± {{ total_duration }} –º–∏–Ω</span>
            </div>
          </div>

          <ul class="list-group list-group-flush bm-summary-list mb-3">
            {% for service in services %}
              <li class="list-group-item d-flex justify-content-between align-items-start py-2">
                <div class="me-3">
                  <div class="fw-bold text-light">{{ service.name }}</div>
                  <div class="text-muted small">{{ service.duration }} –º–∏–Ω</div>
                </div>
                <div class="text-gold fw-bold">{{ service.price }} ‚Ç∏</div>
              </li>
            {% endfor %}
          </ul>

          <div class="d-flex justify-content-between fw-bold">
            <span class="text-muted">–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥:</span>
            <span class="text-gold fs-5" id="summaryTotal">{{ total_price }} ‚Ç∏</span>
          </div>

          <div class="d-flex justify-content-between mt-1" id="summaryPrepayRow" style="display:none;">
            <span class="text-muted">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (30%):</span>
            <span class="text-gold fw-bold" id="summaryPrepay">0 ‚Ç∏</span>
          </div>

          <div class="d-flex justify-content-between fw-bold mt-1">
            <span class="text-muted">–û—Å—Ç–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å:</span>
            <span class="text-gold fs-5" id="summaryToPay">{{ total_price }} ‚Ç∏</span>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- –§–æ—Ä–º–∞ -->
  <section class="bm-section pt-0">
    <div class="container">
      <form method="post" id="bookingForm" action="{% url 'book_confirm' %}">
        {% csrf_token %}

        <input type="hidden" name="master_id" value="{{ master.id }}">
        {% for service in services %}
          <input type="hidden" name="service_ids" value="{{ service.id }}">
        {% endfor %}

        <input type="hidden" id="totalPriceValue" value="{{ total_price }}">

        <div class="bm-card mx-auto" style="max-width: 820px;">
          <div class="p-4 p-md-5">

            <div class="row g-4 mb-4">

              <!-- –î–∞—Ç–∞ -->
              <div class="col-12 col-md-6">
                <label class="fw-bold fs-5 text-gold mb-2 d-block">–î–∞—Ç–∞</label>
                <input type="text"
                       id="datepicker"
                       class="form-control form-control-lg bm-input"
                       placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É"
                       required>
                <input type="hidden" name="date" id="selectedDate">
                <div class="text-muted small mt-2">–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π</div>
              </div>

              <!-- –í—Ä–µ–º—è -->
              <div class="col-12 col-md-6">
                <label class="fw-bold fs-5 text-gold mb-2 d-block">–í—Ä–µ–º—è</label>

                <div class="text-muted small mb-2">
                  –í—ã–±—Ä–∞–Ω–æ: <span class="text-gold fw-bold" id="pickedTimeText">‚Äî</span>
                </div>

                <div class="d-flex flex-wrap gap-2 align-items-start" id="timeButtons">
                  <div class="spinner-border text-gold mx-auto my-4" role="status" id="timeLoader" style="display:none;">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                  </div>

                  <p id="noSlotsMsg" class="text-danger fw-bold d-none w-100 text-center my-4">
                    –ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
                  </p>
                </div>

                <input type="hidden" name="time" id="selectedTime" required>
              </div>

            </div>

            <!-- –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ -->
            <div class="mt-4">
              <h4 class="text-gold fw-bold mb-3">–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</h4>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="fw-bold text-muted">–ò–º—è</label>
                  <input type="text"
                         name="client_name"
                         class="form-control bm-input"
                         value="{% if user.is_authenticated %}{{ user.first_name }}{% endif %}"
                         required>
                </div>

                <div class="col-md-6">
                  <label class="fw-bold text-muted">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                  <input type="tel"
                         id="phoneInput"
                         name="client_phone"
                         class="form-control bm-input"
                         value="{% if user.is_authenticated %}{{ user.client.phone }}{% endif %}"
                         required
                         {% if user.is_authenticated %}readonly{% endif %}>
                </div>

                {% if not user.is_authenticated %}
                <div class="col-md-6">
                  <label class="fw-bold text-muted">–ü–∞—Ä–æ–ª—å</label>
                  <input type="password" name="password" class="form-control bm-input" required>
                </div>
                <div class="col-md-6">
                  <label class="fw-bold text-muted">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–∞—Ä–æ–ª—å</label>
                  <input type="password" name="password2" class="form-control bm-input">
                </div>
                {% endif %}

                <div class="col-12">
                  <label class="fw-bold text-muted">Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                  <input type="email"
                         name="client_email"
                         class="form-control bm-input"
                         value="{% if user.is_authenticated %}{{ user.email }}{% endif %}">
                </div>
              </div>
            </div>

            <!-- –û—Ñ–µ—Ä—Ç–∞ -->
            <div class="form-check mt-4 text-center">
              <input class="form-check-input" type="checkbox" name="agree_offer" id="agreeOffer" required>
              <label class="form-check-label text-light" for="agreeOffer">
                –Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å
                <a href="#" data-bs-toggle="modal" data-bs-target="#offerModal" class="text-gold fw-bold">
                  –ø—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–æ–π
                </a>
              </label>
            </div>

            <!-- –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ -->
            <div class="form-check mt-3 text-center">
              <input class="form-check-input" type="checkbox" name="prepayment" id="prepaymentCheck">
              <label class="form-check-label text-light" for="prepaymentCheck">
                –í–Ω–µ—Å—Ç–∏ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É <span class="text-gold fw-bold">30%</span>
                <span class="text-gold fw-bold" id="prepayInline" style="display:none;">
                  (<span id="prepayInlineAmount">0</span> ‚Ç∏)
                </span>
              </label>

              <div class="text-muted mt-2" style="font-size:0.92rem;">
                –≠—Ç–æ <b>–∏–º–∏—Ç–∞—Ü–∏—è –æ–ø–ª–∞—Ç—ã</b>: —Å–∞–π—Ç –Ω–µ –∂–¥—ë—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂, –∞ –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—É–º–º—É –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã.
              </div>
            </div>

            <!-- –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
            <div class="mt-3 text-center">
              <div class="text-muted fw-bold mb-2">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>

              <div id="payOnSiteBlock" class="d-flex flex-wrap gap-3 justify-content-center">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="payment_method" id="payCash" value="cash" checked>
                  <label class="form-check-label text-light" for="payCash">–ù–∞–ª–∏—á–Ω—ã–º–∏</label>
                </div>

                <div class="form-check">
                  <input class="form-check-input" type="radio" name="payment_method" id="payCard" value="card">
                  <label class="form-check-label text-light" for="payCard">–ö–∞—Ä—Ç–æ–π</label>
                </div>

                <div class="form-check">
                  <input class="form-check-input" type="radio" name="payment_method" id="payQr" value="kaspi_qr">
                  <label class="form-check-label text-light" for="payQr">Kaspi QR</label>
                </div>
              </div>

              <div id="payPrepayBlock" class="mt-2" style="display:none;">
                <span class="text-muted">–°–ø–æ—Å–æ–± –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã:</span>
                <span class="text-gold fw-bold">Kaspi Pay (–∏–º–∏—Ç–∞—Ü–∏—è)</span>
              </div>
            </div>

            <!-- –î–µ—Å–∫—Ç–æ–ø –∫–Ω–æ–ø–∫–∞ -->
            <div class="text-center mt-4 d-none d-md-block">
              <button type="submit"
                      class="btn btn-outline-gold btn-lg px-5 py-3 fw-bold rounded-pill shadow-lg"
                      disabled
                      id="submitBtnDesktop">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
              </button>
            </div>

          </div>
        </div>

        <!-- –ú–æ–± –∫–Ω–æ–ø–∫–∞ fixed -->
        <div class="fixed-bottom d-md-none bg-dark border-top border-secondary py-3 px-4 shadow-lg"
             id="mobileActionBar" style="display:none;">
          <div class="container-fluid text-center">
            <button type="submit"
                    class="btn btn-outline-gold btn-lg px-5 fw-bold rounded-pill shadow-lg"
                    disabled
                    id="submitBtnMobile">
              –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
            </button>
          </div>
        </div>

      </form>
    </div>
  </section>

</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –æ—Ñ–µ—Ä—Ç—ã -->
<div class="modal fade" id="offerModal" tabindex="-1" aria-labelledby="offerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light border-0 shadow-lg" style="border-radius: 16px;">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-gold" id="offerModalLabel">–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞ BladeMaster</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>

      <div class="modal-body">
        <p class="mb-3">
          –ù–∞—Å—Ç–æ—è—â–∞—è –ø—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –±–∞—Ä–±–µ—Ä—à–æ–ø–∞
          <strong>¬´BladeMaster¬ª</strong> –∑–∞–∫–ª—é—á–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ–∫–∞–∑–∞–Ω–∏–µ —É—Å–ª—É–≥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö:
        </p>

        <ol class="text-light">
          <li>–ó–∞–ø–∏—Å—å –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–∞–π—Ç. –û–ø–ª–∞—Ç–∞ ‚Äî –Ω–∞ –º–µ—Å—Ç–µ –Ω–∞–ª–∏—á–Ω—ã–º–∏ –∏–ª–∏ –∫–∞—Ä—Ç–æ–π.</li>
          <li>–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ –º–µ–Ω–µ–µ —á–µ–º –∑–∞ 2 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞ ‚Äî —à—Ç—Ä–∞—Ñ 50% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É—Å–ª—É–≥–∏.</li>
          <li>–û–ø–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 15 –º–∏–Ω—É—Ç –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏—é –∑–∞–ø–∏—Å–∏.</li>
          <li>–ö–ª–∏–µ–Ω—Ç –æ–±—è–∑—É–µ—Ç—Å—è —Å–æ–±–ª—é–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤ –∑–∞–≤–µ–¥–µ–Ω–∏–∏.</li>
          <li>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –æ—Ñ–µ—Ä—Ç—ã.</li>
        </ol>

        <div class="mt-4 p-3 text-center" style="border: 1px dashed rgba(255,215,0,0.35); border-radius: 14px;">
          <div class="mb-2" style="color: var(--gold); font-weight: 700;">–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –æ—Ñ–µ—Ä—Ç—ã</div>
          <a href="{% url 'offer' %}" class="btn btn-outline-gold px-4 py-2 rounded-pill fw-bold">
            –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ñ–µ—Ä—Ç—ã
          </a>
          <div class="text-muted mt-2" style="font-size: 0.9rem;">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ PDF</div>
        </div>

        <p class="text-muted small mt-4 text-center">–ë–∞—Ä–±–µ—Ä—à–æ–ø ¬´BladeMaster¬ª, –≥. –ê–ª–º–∞—Ç—ã, 2026 –≥–æ–¥</p>
      </div>

      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-gold rounded-pill px-4 fw-bold" data-bs-dismiss="modal">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>
  </div>
</div>

<!-- scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<script src="https://unpkg.com/imask"></script>

<input type="hidden" id="initialDate" value="{{ dates.0|date:'Y-m-d' }}">

<script>
  // –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  const phoneEl = document.getElementById('phoneInput');
  if (phoneEl) {
    IMask(phoneEl, {
      mask: '+{7} (000) 000-00-00',
      lazy: false,
      placeholderChar: '_'
    });
  }

  const timeButtonsContainer = document.getElementById('timeButtons');
  const selectedTimeInput = document.getElementById('selectedTime');
  const selectedDateInput = document.getElementById('selectedDate');
  const pickedTimeText = document.getElementById('pickedTimeText');

  const submitBtnDesktop = document.getElementById('submitBtnDesktop');
  const submitBtnMobile = document.getElementById('submitBtnMobile');
  const mobileBar = document.getElementById('mobileActionBar');

  const timeLoader = document.getElementById('timeLoader');
  const noSlotsMsg = document.getElementById('noSlotsMsg');

  const masterId = '{{ master.id }}';
  const initialDate = document.getElementById('initialDate')?.value;

  // –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ UI + —Å–≤–æ–¥–∫–∞
  const prepayCheck = document.getElementById("prepaymentCheck");
  const totalPriceValue = document.getElementById("totalPriceValue");
  const prepayInline = document.getElementById("prepayInline");
  const prepayInlineAmount = document.getElementById("prepayInlineAmount");
  const payOnSiteBlock = document.getElementById("payOnSiteBlock");
  const payPrepayBlock = document.getElementById("payPrepayBlock");

  function fmt(n) {
    const x = Math.max(0, Math.round(n || 0));
    return x.toString();
  }

  function updateSummaryPayment() {
    const raw = (totalPriceValue?.value || "0").toString().replace(/\s/g, "");
    const total = parseFloat(raw) || 0;
    const prepay = Math.round(total * 0.30);
    const toPay = Math.max(0, Math.round(total - prepay));

    const summaryPrepayRow = document.getElementById("summaryPrepayRow");
    const summaryPrepay = document.getElementById("summaryPrepay");
    const summaryToPay = document.getElementById("summaryToPay");

    if (prepayCheck && prepayCheck.checked) {
      if (summaryPrepayRow) summaryPrepayRow.style.display = "flex";
      if (summaryPrepay) summaryPrepay.textContent = fmt(prepay) + " ‚Ç∏";
      if (summaryToPay) summaryToPay.textContent = fmt(toPay) + " ‚Ç∏";

      if (prepayInline) prepayInline.style.display = "inline";
      if (prepayInlineAmount) prepayInlineAmount.textContent = fmt(prepay);

      if (payOnSiteBlock) {
        payOnSiteBlock.style.opacity = "0.5";
        payOnSiteBlock.style.pointerEvents = "none";
      }
      if (payPrepayBlock) payPrepayBlock.style.display = "block";
    } else {
      if (summaryPrepayRow) summaryPrepayRow.style.display = "none";
      if (summaryToPay) summaryToPay.textContent = fmt(total) + " ‚Ç∏";

      if (prepayInline) prepayInline.style.display = "none";

      if (payOnSiteBlock) {
        payOnSiteBlock.style.opacity = "1";
        payOnSiteBlock.style.pointerEvents = "auto";
      }
      if (payPrepayBlock) payPrepayBlock.style.display = "none";
    }
  }

  if (prepayCheck) {
    prepayCheck.addEventListener("change", updateSummaryPayment);
    updateSummaryPayment();
  }

  function setSelectedTimeButton(btn) {
    document.querySelectorAll('.bm-time-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  function loadFreeSlots(dateStr) {
    timeButtonsContainer.innerHTML = '';
    timeLoader.style.display = 'inline-block';
    noSlotsMsg.classList.add('d-none');

    fetch(`/get-free-slots/${masterId}/${dateStr}/`)
      .then(res => res.json())
      .then(data => {
        timeLoader.style.display = 'none';

        if (data.free_slots && data.free_slots.length > 0) {
          data.free_slots.forEach(time => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-gold bm-time-btn px-3 py-2';
            btn.dataset.time = time;
            btn.textContent = time;

            btn.addEventListener('click', () => {
              setSelectedTimeButton(btn);
              selectedTimeInput.value = time;
              if (pickedTimeText) pickedTimeText.textContent = time;
              checkFormReady();
            });

            timeButtonsContainer.appendChild(btn);
          });
        } else {
          noSlotsMsg.classList.remove('d-none');
        }

        checkFormReady();
      })
      .catch(() => {
        timeLoader.style.display = 'none';
        timeButtonsContainer.innerHTML = '<p class="text-warning fw-bold w-100 text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—Ç–æ–≤</p>';
      });
  }

  flatpickr("#datepicker", {
    dateFormat: "Y-m-d",
    minDate: "today",
    maxDate: new Date().fp_incr(30),
    locale: "ru",
    defaultDate: initialDate,
    onChange: function (_, dateStr) {
      selectedDateInput.value = dateStr;
      selectedTimeInput.value = '';
      if (pickedTimeText) pickedTimeText.textContent = '‚Äî';
      loadFreeSlots(dateStr);
      checkFormReady();
    }
  });

  // init
  if (initialDate) {
    selectedDateInput.value = initialDate;
    selectedTimeInput.value = '';
    if (pickedTimeText) pickedTimeText.textContent = '‚Äî';
    loadFreeSlots(initialDate);
  }

  function checkFormReady() {
    const dateOk = !!selectedDateInput.value;
    const timeOk = !!selectedTimeInput.value;
    const ready = dateOk && timeOk;

    submitBtnDesktop.disabled = !ready;
    submitBtnMobile.disabled = !ready;
    mobileBar.style.display = ready ? 'block' : 'none';
  }

  document.getElementById('bookingForm').addEventListener('submit', function (e) {
    if (!selectedDateInput.value || !selectedTimeInput.value) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è!');
      e.preventDefault();
    }
  });
</script>

{% endblock %}
