{% extends 'base.html' %}

{% block content %}

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<section class="py-5 text-center border-bottom border-secondary">
  <div class="container" data-aos="fade-down">
    <h1 class="display-5 fw-bold text-gold mb-3">–ù–∞—à–∏ —É—Å–ª—É–≥–∏</h1>
    <p class="lead text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–¥—É—Ä</p>
    {% if selected_master %}
      <p class="text-gold fw-bold">–ú–∞—Å—Ç–µ—Ä: {{ selected_master.full_name }} (–ø—Ä–µ–¥–≤—ã–±—Ä–∞–Ω)</p>
    {% endif %}
  </div>
</section>

<!-- –ü–æ–∏—Å–∫ -->
<div class="container mt-4" data-aos="fade-up">
  <form method="get" action="{% url 'services' %}"
        class="row g-2 g-md-3 justify-content-center align-items-stretch search-form">

    {# –µ—Å–ª–∏ –º–∞—Å—Ç–µ—Ä –ø—Ä–µ–¥–≤—ã–±—Ä–∞–Ω ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ #}
    {% if selected_master %}
      <input type="hidden" name="master" value="{{ selected_master.id }}">
    {% endif %}

    <div class="col-12 col-md-6">
      <input
        type="search"
        name="q"
        class="form-control form-control-lg bg-dark text-light border-gold"
        placeholder="–ü–æ–∏—Å–∫ —É—Å–ª—É–≥: —Å—Ç—Ä–∏–∂–∫–∞, –±–æ—Ä–æ–¥–∞, —É—Ö–æ–¥..."
        value="{{ q }}"
        autocomplete="off"
      >
    </div>

    <div class="col-12 col-md-auto">
      <button type="submit" class="btn btn-gold btn-lg w-100 w-md-auto">
        –ù–∞–π—Ç–∏
      </button>
    </div>

    {% if q %}
      <div class="col-12 text-center">
        <a class="text-muted"
           href="{% url 'services' %}{% if selected_master %}?master={{ selected_master.id }}{% endif %}">
          –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫
        </a>
      </div>
    {% endif %}
  </form>

  {% if q %}
    <p class="text-center text-muted mt-3 mb-0 px-2">
      –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É: <strong>¬´{{ q }}¬ª</strong>
    </p>
  {% endif %}
</div>

<section class="py-5">
  <div class="container">

    <!-- –§–∏–ª—å—Ç—Ä -->
    <div class="text-center mb-5" data-aos="fade-up" data-aos-delay="100">
      <select id="categoryFilter"
              class="form-select form-select-lg w-100 w-md-50-custom mx-auto bg-secondary text-light border-gold">
        <option value="all" selected>–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        <option value="haircut">–°—Ç—Ä–∏–∂–∫–∏</option>
        <option value="beard">–ë—Ä–∏—Ç—å—ë –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –±–æ—Ä–æ–¥—ã</option>
        <option value="care">–£—Ö–æ–¥</option>
        <option value="complex">–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã</option>
      </select>
    </div>

    <form method="post"
          action="{% if selected_master %}{% url 'book_datetime_multi' %}{% else %}{% url 'book_select_master' %}{% endif %}"
          id="servicesForm">
      {% csrf_token %}
      {% if selected_master %}
        <input type="hidden" name="master_id" value="{{ selected_master.id }}">
      {% endif %}

      <div class="row g-4" id="servicesList">

        {% if services %}
          {% for service in services %}
            <div class="col-md-6 col-lg-4 service-card"
                 data-category="{{ service.category|lower }}"
                 data-aos="zoom-in"
                 data-aos-delay="{% cycle '100' '200' '300' '100' %}">
              <div class="card h-100 bg-dark border-0 shadow-lg hover-lift">
                <div class="card-body d-flex flex-column p-4 text-center">
                  <h5 class="card-title fw-bold fs-4 text-gold mb-3">{{ service.name }}</h5>
                  <p class="text-muted flex-grow-1 mb-4">
                    {{ service.description|default:"–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–µ–º–∏—É–º-–ø—Ä–æ—Ü–µ–¥—É—Ä–∞"|truncatechars:100 }}
                  </p>

                  <div class="mt-auto">
                    <p class="fs-3 fw-bold text-gold mb-2">{{ service.price }} ‚Ç∏</p>
                    <p class="text-muted small mb-3">
                      <i class="bi bi-clock me-1"></i> {{ service.duration }} –º–∏–Ω
                    </p>

                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox"
                             name="services" value="{{ service.id }}"
                             id="service{{ service.id }}" data-name="{{ service.name }}">
                      <label class="form-check-label fw-medium" for="service{{ service.id }}">
                        –í—ã–±—Ä–∞—Ç—å
                      </label>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <!-- –ù–ò–ß–ï–ì–û –ù–ï –ù–ê–ô–î–ï–ù–û (–ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞) -->
          <div class="col-12 text-center py-5" data-aos="fade-up">
            <h4 class="text-muted mb-3">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòï</h4>
            <p class="text-secondary mb-4">
              –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
            </p>
            <a href="{% url 'services' %}{% if selected_master %}?master={{ selected_master.id }}{% endif %}"
               class="btn btn-outline-gold btn-lg">
              –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —É—Å–ª—É–≥–∏
            </a>
          </div>
        {% endif %}

      </div>

      <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö + –æ–±—ã—á–Ω–∞—è –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø -->
      <div class="fixed-bottom d-md-none bg-dark border-top border-secondary py-3 px-4 shadow-lg"
           id="mobileActionBar" style="display: none;">
        <div class="container-fluid">
          <div class="d-flex align-items-center justify-content-between">
            <div class="text-gold fw-bold" id="selectedCountMobile">0 —É—Å–ª—É–≥ –≤—ã–±—Ä–∞–Ω–æ</div>
            <button type="submit" class="btn btn-gold btn-lg px-5 fw-bold rounded-pill"
                    disabled id="submitBtnMobile">
              –î–∞–ª–µ–µ ‚Üí –ú–∞—Å—Ç–µ—Ä
            </button>
          </div>
        </div>
      </div>

      <!-- –û–±—ã—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø -->
      <div class="text-center mt-5 pt-5 d-none d-md-block" id="desktopSubmit">
        <div class="mb-3">
          <span class="fs-5 fw-bold text-gold" id="selectedCountDesktop">–í—ã–±—Ä–∞–Ω–æ —É—Å–ª—É–≥: 0</span>
        </div>
        <button type="submit" class="btn btn-gold btn-lg px-5 py-3 fw-bold rounded-pill shadow-lg"
                disabled id="submitBtnDesktop">
          –î–∞–ª–µ–µ ‚Üí –í—ã–±—Ä–∞—Ç—å –º–∞—Å—Ç–µ—Ä–∞
        </button>
      </div>

    </form>
  </div>
</section>

<script>
  // –§–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  document.getElementById('categoryFilter').addEventListener('change', function () {
    const selected = this.value.toLowerCase();
    const cards = document.querySelectorAll('.service-card');

    cards.forEach(card => {
      const cardCategory = card.dataset.category;
      card.style.display = (selected === 'all' || cardCategory === selected) ? 'block' : 'none';
    });

    setTimeout(() => AOS.refreshHard(), 100);
  });

  // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥ + –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
  const checkboxes = document.querySelectorAll('input[name="services"]');
  const submitBtnDesktop = document.getElementById('submitBtnDesktop');
  const submitBtnMobile = document.getElementById('submitBtnMobile');
  const selectedCountDesktop = document.getElementById('selectedCountDesktop');
  const selectedCountMobile = document.getElementById('selectedCountMobile');
  const mobileBar = document.getElementById('mobileActionBar');

  function updateSelection() {
    const selected = Array.from(checkboxes).filter(cb => cb.checked).length;

    const text = selected === 0 ? '0 —É—Å–ª—É–≥ –≤—ã–±—Ä–∞–Ω–æ' : `${selected} —É—Å–ª—É–≥ –≤—ã–±—Ä–∞–Ω–æ`;

    selectedCountDesktop.textContent = `–í—ã–±—Ä–∞–Ω–æ —É—Å–ª—É–≥: ${selected}`;
    selectedCountMobile.textContent = text;

    const isDisabled = selected === 0;

    if (submitBtnDesktop) submitBtnDesktop.disabled = isDisabled;
    if (submitBtnMobile) submitBtnMobile.disabled = isDisabled;

    if (mobileBar) mobileBar.style.display = selected > 0 ? 'block' : 'none';
  }

  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateSelection);
  });

  updateSelection();

  // hover-—ç—Ñ—Ñ–µ–∫—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –æ—Å—Ç–∞–≤–∏–ª)
  document.querySelectorAll('.service-card').forEach(card => {
    card.addEventListener('mouseenter', () => card.classList.add('hover-lift'));
    card.addEventListener('mouseleave', () => card.classList.remove('hover-lift'));
  });
</script>

<style>
  .hover-lift {
    transform: translateY(-8px);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45) !important;
  }

  .fixed-bottom { z-index: 1000; }

  .form-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23FFD700' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
    background-position: right 1rem center;
    background-size: 12px;
  }

  .border-gold { border-color: #FFD700 !important; }

  /* –ê–î–ê–ü–¢–ò–í –î–õ–Ø –ü–û–ò–°–ö–ê */
  .search-form .form-control,
  .search-form .btn {
    height: 52px;
  }

  @media (min-width: 768px) {
    .w-md-auto { width: auto !important; }
    .w-md-50-custom { width: 50% !important; }
  }
</style>

{% endblock %}
