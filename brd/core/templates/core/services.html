{% extends 'base.html' %}

{% block extra_head %}
<style>
  /* Чтобы placeholder был виден даже если в base не добавлял */
  .bm-input::placeholder {
    color: rgba(224, 224, 224, 0.55) !important;
  }

  /* Чипы категорий */
  .bm-filter-chip {
    border: 1px solid rgba(255,215,0,0.55);
    color: rgba(255,215,0,0.95);
    background: transparent;
    border-radius: 999px;
    padding: .55rem 1rem;
    font-weight: 700;
    transition: all .2s ease;
    white-space: nowrap;
  }
  .bm-filter-chip:hover {
    background: var(--gold);
    color: #000;
    border-color: var(--gold);
  }
  .bm-filter-chip.active {
    background: var(--gold);
    color: #000;
    border-color: var(--gold);
  }

  /* Чуть ровнее сетка чипов на мобилке */
  @media (max-width: 768px) {
    .bm-filter-chip { width: 48%; text-align: center; }
  }

  /* Небольшой бейдж на карточке */
  .bm-badge {
    position: absolute;
    top: 7px;
    left: 7px;
    font-size: .78rem;
    font-weight: 900;
    padding: .2rem .2rem;
    border-radius: 999px;
    background: rgba(255, 215, 0, 0.12);
    border: 1px solid rgba(255, 215, 0, 0.35);
    color: var(--gold);
    backdrop-filter: blur(6px);
}
</style>
{% endblock %}

{% block content %}

<div class="bm-has-actionbar">

  <!-- Заголовок страницы -->
  <section class="bm-page-title">
    <div class="container" data-aos="fade-down">
      <h1 class="display-5 fw-bold text-gold mb-3">Наши услуги</h1>
      <p class="lead text-muted">Выберите одну или несколько процедур</p>
      {% if selected_master %}
        <p class="text-gold fw-bold mb-0">Мастер: {{ selected_master.full_name }} (предвыбран)</p>
      {% endif %}
    </div>
  </section>

  <!-- Поиск -->
  <div class="container mt-4" data-aos="fade-up">
    <form method="get" action="{% url 'services' %}" class="row g-2 g-md-3 justify-content-center align-items-stretch">

      {% if selected_master %}
        <input type="hidden" name="master" value="{{ selected_master.id }}">
      {% endif %}

      <div class="col-12 col-md-6">
        <input
          type="search"
          name="q"
          class="form-control form-control-lg bm-input"
          placeholder="Поиск услуг: стрижка, борода, уход..."
          value="{{ q }}"
        >
      </div>

      <div class="col-12 col-md-auto">
        <!-- В одном стиле: прозрачная кнопка -->
        <button type="submit" class="btn btn-outline-gold btn-lg w-100 w-md-auto rounded-pill fw-bold">
          Найти
        </button>
      </div>

      {% if q %}
        <div class="col-12 text-center">
          <a class="text-muted" href="{% url 'services' %}{% if selected_master %}?master={{ selected_master.id }}{% endif %}">
            Сбросить поиск
          </a>
        </div>
      {% endif %}
    </form>

    <!-- Быстрые подсказки, если поиск пустой -->
    {% if q and not services %}
      <div class="text-center mt-3">
        <div class="text-muted mb-2">Попробуй так:</div>
        <div class="d-flex flex-wrap gap-2 justify-content-center">
          <a class="btn btn-outline-gold rounded-pill fw-bold"
             href="{% url 'services' %}?q=стрижка{% if selected_master %}&master={{ selected_master.id }}{% endif %}">
            стрижка
          </a>
          <a class="btn btn-outline-gold rounded-pill fw-bold"
             href="{% url 'services' %}?q=борода{% if selected_master %}&master={{ selected_master.id }}{% endif %}">
            борода
          </a>
          <a class="btn btn-outline-gold rounded-pill fw-bold"
             href="{% url 'services' %}?q=уход{% if selected_master %}&master={{ selected_master.id }}{% endif %}">
            уход
          </a>
        </div>
      </div>
    {% endif %}
  </div>

  <section class="bm-section">
    <div class="container">

      <!-- Чипы категорий (вместо select) -->
      <div class="text-center mb-4" data-aos="fade-up" data-aos-delay="100">
        <div class="d-flex flex-wrap gap-2 justify-content-center" id="categoryChips">
          <button type="button" class="bm-filter-chip active" data-category="all">Все</button>
          <button type="button" class="bm-filter-chip" data-category="haircut">Стрижки</button>
          <button type="button" class="bm-filter-chip" data-category="beard">Борода</button>
          <button type="button" class="bm-filter-chip" data-category="care">Уход</button>
          <button type="button" class="bm-filter-chip" data-category="complex">Комплекс</button>
        </div>
      </div>

      <form method="post"
            action="{% if selected_master %}{% url 'book_datetime_multi' %}{% else %}{% url 'book_select_master' %}{% endif %}"
            id="servicesForm">
        {% csrf_token %}
        {% if selected_master %}
          <input type="hidden" name="master_id" value="{{ selected_master.id }}">
        {% endif %}

        <div class="row g-4" id="servicesList">
          {% for service in services %}
            <div class="col-12 col-md-6 col-lg-4 service-card"
                 data-category="{{ service.category|lower }}"
                 data-aos="zoom-in"
                 data-aos-delay="{% cycle '100' '200' '300' '100' %}">

              <div class="bm-card bm-card-hover h-100 position-relative">
                {# лёгкий декоративный бейдж: можно позже сделать "ТОП" из модели #}
                {% if forloop.counter == 1 %}
                  <div class="bm-badge">Популярно</div>
                {% endif %}

                <div class="card-body d-flex flex-column p-4 text-center">
                  <h5 class="card-title fw-bold fs-4 text-gold mb-3">{{ service.name }}</h5>
                  <p class="text-muted flex-grow-1 mb-4">
                    {{ service.description|default:"Профессиональная премиум-процедура"|truncatechars:100 }}
                  </p>

                  <div class="mt-auto">
                    <p class="fs-3 fw-bold text-gold mb-2">{{ service.price }} ₸</p>
                    <p class="text-muted small mb-3">
                      <i class="bi bi-clock me-1"></i> {{ service.duration }} мин
                    </p>

                    <div class="form-check mt-2 d-flex justify-content-center gap-2 align-items-center">
                      <input class="form-check-input service-checkbox"
                             type="checkbox"
                             name="services"
                             value="{{ service.id }}"
                             id="service{{ service.id }}"
                             data-name="{{ service.name }}"
                             data-price="{{ service.price }}"
                             data-duration="{{ service.duration }}">
                      <label class="form-check-label fw-medium" for="service{{ service.id }}">
                        Выбрать
                      </label>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          {% empty %}
            <div class="col-12 text-center py-5">
              {% if q %}
                <p class="text-muted fs-5 mb-2">
                  По запросу <span class="text-gold fw-bold">“{{ q }}”</span> ничего не найдено
                </p>
                <a class="btn btn-outline-gold btn-md rounded-pill fw-bold w-100 w-md-auto"
                   href="{% url 'services' %}{% if selected_master %}?master={{ selected_master.id }}{% endif %}">
                  Показать все услуги
                </a>
              {% else %}
                <p class="text-muted fs-5">Услуги пока не добавлены</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <!-- Фиксированная панель на мобильных -->
        <div class="fixed-bottom d-md-none bg-dark border-top border-secondary py-3 px-3 shadow-lg"
             id="mobileActionBar" style="display: none;">
          <div class="container-fluid">
            <div class="d-flex align-items-center justify-content-between gap-2">
              <div class="text-gold fw-bold small" style="line-height: 1.2;">
                <div id="selectedCountMobile">0 услуг</div>
                <div class="text-muted" style="font-weight: 600;">
                  <span id="totalPriceMobile">0</span> ₸ • <span id="totalDurationMobile">0</span> мин
                </div>
              </div>
              <button type="submit"
                      class="btn btn-outline-gold btn-lg px-4 fw-bold rounded-pill"
                      disabled id="submitBtnMobile">
                Далее →
              </button>
            </div>
          </div>
        </div>

        <!-- Десктоп блок -->
        <div class="text-center mt-5 pt-4 d-none d-md-block" id="desktopSubmit">
          <div class="mb-3">
            <div class="fs-5 fw-bold text-gold" id="selectedCountDesktop">Выбрано: 0</div>
            <div class="text-muted fw-semibold">
              Итого: <span class="text-gold fw-bold" id="totalPriceDesktop">0</span> ₸
              • Длительность: <span class="text-gold fw-bold" id="totalDurationDesktop">0</span> мин
            </div>
          </div>
          <button type="submit"
                  class="btn btn-outline-gold btn-lg px-5 py-3 fw-bold rounded-pill shadow-lg"
                  disabled id="submitBtnDesktop">
            Далее → {% if selected_master %}Время{% else %}Выбрать мастера{% endif %}
          </button>
        </div>

      </form>
    </div>
  </section>

</div>

<script>
  // --- Категории (чипы) ---
  const chipsWrap = document.getElementById('categoryChips');
  const serviceCards = document.querySelectorAll('.service-card');

  function applyCategory(category) {
    const selected = (category || 'all').toLowerCase();

    serviceCards.forEach(card => {
      const cardCategory = (card.dataset.category || '').toLowerCase();
      card.style.display = (selected === 'all' || cardCategory === selected) ? 'block' : 'none';
    });

    // AOS обновим (чтобы анимации не глючили)
    setTimeout(() => { if (window.AOS) AOS.refreshHard(); }, 80);
  }

  chipsWrap?.addEventListener('click', (e) => {
    const btn = e.target.closest('.bm-filter-chip');
    if (!btn) return;

    chipsWrap.querySelectorAll('.bm-filter-chip').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    applyCategory(btn.dataset.category);
  });

  // --- Выбор услуг + подсчёт ---
  const checkboxes = document.querySelectorAll('.service-checkbox');
  const submitBtnDesktop = document.getElementById('submitBtnDesktop');
  const submitBtnMobile = document.getElementById('submitBtnMobile');

  const selectedCountDesktop = document.getElementById('selectedCountDesktop');
  const selectedCountMobile = document.getElementById('selectedCountMobile');

  const totalPriceDesktop = document.getElementById('totalPriceDesktop');
  const totalDurationDesktop = document.getElementById('totalDurationDesktop');

  const totalPriceMobile = document.getElementById('totalPriceMobile');
  const totalDurationMobile = document.getElementById('totalDurationMobile');

  const mobileBar = document.getElementById('mobileActionBar');

  function updateSelection() {
    const selected = Array.from(checkboxes).filter(cb => cb.checked);

    const count = selected.length;

    let price = 0;
    let duration = 0;

    selected.forEach(cb => {
      const p = parseFloat((cb.dataset.price || "0").toString().replace(/\s/g,''));
      const d = parseInt(cb.dataset.duration || "0", 10);
      price += isNaN(p) ? 0 : p;
      duration += isNaN(d) ? 0 : d;
    });

    // Тексты
    if (selectedCountDesktop) selectedCountDesktop.textContent = `Выбрано: ${count}`;
    if (selectedCountMobile) selectedCountMobile.textContent = `${count} услуг`;

    if (totalPriceDesktop) totalPriceDesktop.textContent = Math.round(price).toString();
    if (totalDurationDesktop) totalDurationDesktop.textContent = duration.toString();

    if (totalPriceMobile) totalPriceMobile.textContent = Math.round(price).toString();
    if (totalDurationMobile) totalDurationMobile.textContent = duration.toString();

    // Кнопки
    const disabled = count === 0;
    if (submitBtnDesktop) submitBtnDesktop.disabled = disabled;
    if (submitBtnMobile) submitBtnMobile.disabled = disabled;

    if (mobileBar) mobileBar.style.display = disabled ? 'none' : 'block';
  }

  checkboxes.forEach(cb => cb.addEventListener('change', updateSelection));
  updateSelection();
</script>

{% endblock %}
