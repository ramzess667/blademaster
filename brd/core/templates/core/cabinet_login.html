{% extends 'base.html' %}

{% block extra_head %}
<style>
  .bm-login-wrap { padding-bottom: 24px; }

  /* Переключатель ролей */
  .bm-role-switch {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn-role {
    border: 1px solid rgba(255,215,0,0.75);
    color: var(--gold);
    background: transparent;
    transition: all 0.2s ease;
    border-radius: 999px;
    font-weight: 800;
    padding: 14px 22px;
    min-width: 190px;
  }
  .btn-role:hover,
  .btn-role.active {
    background: var(--gold);
    color: #000;
    transform: translateY(-1px);
  }

  /* Внутренние подсказки */
  .bm-hint { color: var(--text-muted); font-size: .92rem; }

  /* Адаптивка */
  @media (max-width: 576px) {
    .btn-role { width: 100%; min-width: auto; }
  }
</style>
{% endblock %}

{% block content %}

<div class="bm-login-wrap">

  <!-- Заголовок -->
  <section class="bm-page-title">
    <div class="container" data-aos="fade-down">
      <h1 class="display-6 fw-bold text-gold mb-2 text-center">Вход в личный кабинет</h1>
      <p class="lead text-muted text-center mb-0">Выберите роль</p>
    </div>
  </section>

  <!-- Форма входа -->
  <section class="bm-section pt-4">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-7 col-lg-6 col-xl-5">

          <div class="bm-card p-0 overflow-hidden">
            <div class="p-4 p-md-5">

              <!-- Роли -->
              <div class="bm-role-switch mb-4" role="tablist" aria-label="Выбор роли">
                <button type="button" class="btn btn-role active" data-role="client" aria-pressed="true">
                  Я клиент
                </button>

                <button type="button" class="btn btn-role" data-role="master" aria-pressed="false">
                  Я мастер
                </button>
              </div>

              {% if messages %}
                <div class="alert alert-danger text-center mb-4">
                  {% for message in messages %}{{ message }}{% endfor %}
                </div>
              {% endif %}

              <form method="post" id="loginForm" novalidate>
                {% csrf_token %}

                <div class="mb-3">
                  <label class="form-label fw-bold text-light" id="usernameLabel">Телефон</label>
                  <input type="text"
                         name="username"
                         id="usernameInput"
                         class="form-control form-control-lg bm-input"
                         placeholder="+7 (___) ___-__-__"
                         required
                         autofocus>
                  <div class="bm-hint mt-1" id="usernameHint">Ваш номер телефона</div>
                </div>

                <div class="mb-4">
                  <label class="form-label fw-bold text-light">Пароль</label>
                  <input type="password"
                         name="password"
                         class="form-control form-control-lg bm-input"
                         required>
                </div>

                <div class="d-grid">
                  <button type="submit"
                          class="btn btn-outline-gold btn-lg fw-bold rounded-pill shadow-lg"
                          id="submitBtn">
                    Войти
                    <span class="spinner-border spinner-border-sm ms-2 d-none"
                          role="status"
                          id="loginLoader"
                          aria-hidden="true"></span>
                  </button>
                </div>
              </form>

              <div class="text-center mt-4">
                <p class="text-muted small mb-2">
                  Клиенты: вход по номеру телефона<br>
                  Мастера: вход по логину от администратора
                </p>
                <a href="/" class="text-gold text-decoration-none">Вернуться на главную</a>
              </div>

            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

</div>

<!-- IMask + JS -->
<script src="https://unpkg.com/imask"></script>
<script>
  const usernameInput = document.getElementById('usernameInput');
  const usernameLabel = document.getElementById('usernameLabel');
  const usernameHint = document.getElementById('usernameHint');

  const submitBtn = document.getElementById('submitBtn');
  const loginLoader = document.getElementById('loginLoader');
  const form = document.getElementById('loginForm');

  let maskInstance = null;

  function applyPhoneMask() {
    if (maskInstance) maskInstance.destroy();
    maskInstance = IMask(usernameInput, {
      mask: '+{7} (000) 000-00-00',
      lazy: false,
      placeholderChar: '_'
    });
  }

  function removePhoneMask() {
    if (maskInstance) {
      maskInstance.destroy();
      maskInstance = null;
    }
  }

  function setRole(role) {
    document.querySelectorAll('.btn-role').forEach(b => {
      const active = b.dataset.role === role;
      b.classList.toggle('active', active);
      b.setAttribute('aria-pressed', active ? 'true' : 'false');
    });

    // сбрасываем поле при смене роли (чтобы не оставалась маска/символы)
    usernameInput.value = '';

    if (role === 'client') {
      usernameLabel.textContent = 'Телефон';
      usernameHint.textContent = 'Ваш номер телефона';
      usernameInput.placeholder = '+7 (___) ___-__-__';
      applyPhoneMask();
    } else {
      usernameLabel.textContent = 'Логин';
      usernameHint.textContent = 'Логин от администратора';
      usernameInput.placeholder = 'Введите ваш логин';
      removePhoneMask();
    }

    usernameInput.focus();
  }

  // init role = client
  setRole('client');

  document.querySelectorAll('.btn-role').forEach(btn => {
    btn.addEventListener('click', () => setRole(btn.dataset.role));
  });

  // Loader при отправке (только если форма валидна)
  form.addEventListener('submit', function(e) {
    // встроенная HTML-валидация
    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    submitBtn.disabled = true;
    loginLoader.classList.remove('d-none');
  });
</script>

{% endblock %}
