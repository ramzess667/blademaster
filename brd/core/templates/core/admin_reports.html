{% extends "base.html" %}
{% block title %}Отчёты — BladeMaster{% endblock %}

{% block content %}

<style>
    
  .nav-safe-space{height:90px;}
  @media (max-width: 992px){ .nav-safe-space{height:80px;} }
  @media (max-width: 576px){ .nav-safe-space{height:72px;} }

  /* Mobile improvements */
  @media (max-width: 576px){
    .section-title h2 { font-size: 1.6rem; }
    .section-title p { font-size: 0.95rem; }

    .card { border-radius: 14px !important; }
    .table { font-size: 0.9rem; }
    .table th, .table td { padding: 0.65rem 0.55rem; }

    /* чтобы цифры не переносились */
    .nowrap { white-space: nowrap; }

    /* карточки статусов — ровнее */
    .status-card .fs-4 { font-size: 1.35rem !important; }
  }
  .status-card {
    border-radius: 16px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  @media (max-width: 576px){
  .table thead th { font-size: 0.85rem; }
  .table td { font-size: 0.88rem; }
}


  .status-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
  }

  .text-gold {
    color: var(--gold);
  }

  /* Мобилка */
  @media (max-width: 576px) {
    .status-card .fs-4 {
      font-size: 1.3rem;
    }
    .status-card {
      padding: 0.75rem !important;
    }
  }
</style>

<div class="nav-safe-space"></div>

<section class="section">
  <div class="container">
    <div class="section-title">
      <h2>Отчёты</h2>
      <p>Плановая нагрузка и факт выполненных записей за период</p>
    </div>

    <!-- Фильтр дат -->
    <div class="card p-4 mb-4" style="background: rgba(20,20,20,0.85); border: 1px solid rgba(255,215,0,0.25); border-radius: 18px;">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-12 col-md-4">
          <label class="text-muted fw-bold">С</label>
          <input type="date" name="from" value="{{ date_from|date:'Y-m-d' }}" class="form-control bg-dark text-light border-gold">
        </div>
        <div class="col-12 col-md-4">
          <label class="text-muted fw-bold">По</label>
          <input type="date" name="to" value="{{ date_to|date:'Y-m-d' }}" class="form-control bg-dark text-light border-gold">
        </div>
        <div class="col-12 col-md-4">
          <button class="btn btn-warning w-100 fw-bold">Показать</button>
        </div>
      </form>

      <div class="text-muted mt-3" style="font-size: 0.95rem;">
        Период: <span style="color:#ddd">{{ date_from|date:"d.m.Y" }}</span> — <span style="color:#ddd">{{ date_to|date:"d.m.Y" }}</span>
      </div>
    </div>

   <div class="row g-3 mb-4">
  <div class="col-6 col-md-4 col-lg">
    <div class="card p-3 bg-dark border-secondary status-card h-100 text-center">
      <div class="text-muted small">Новые</div>
      <div class="fs-4 fw-bold text-gold">{{ counts.new }}</div>
    </div>
  </div>

  <div class="col-6 col-md-4 col-lg">
    <div class="card p-3 bg-dark border-secondary status-card h-100 text-center">
      <div class="text-muted small">Подтверждённые</div>
      <div class="fs-4 fw-bold text-gold">{{ counts.confirmed }}</div>
    </div>
  </div>

  <div class="col-6 col-md-4 col-lg">
    <div class="card p-3 bg-dark border-secondary status-card h-100 text-center">
      <div class="text-muted small">Выполненные</div>
      <div class="fs-4 fw-bold text-gold">{{ counts.completed }}</div>
    </div>
  </div>

  <div class="col-6 col-md-4 col-lg">
    <div class="card p-3 bg-dark border-secondary status-card h-100 text-center">
      <div class="text-muted small">Не пришёл</div>
      <div class="fs-4 fw-bold text-gold">{{ counts.no_show }}</div>
    </div>
  </div>

  <div class="col-12 col-md-4 col-lg">
    <div class="card p-3 bg-dark border-secondary status-card h-100 text-center">
      <div class="text-muted small">Отменённые</div>
      <div class="fs-4 fw-bold text-gold">{{ counts.cancelled }}</div>
    </div>
  </div>
</div>


    <!-- A) ПЛАН -->
    <div class="card p-4 mb-4" style="background: rgba(20,20,20,0.85); border: 1px solid rgba(255,215,0,0.25); border-radius: 18px;">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <h4 class="mb-0" style="color: var(--gold);">A) Плановая нагрузка (кроме отмен)</h4>
        <div class="text-muted">
          Записей: <b style="color:#ddd">{{ total_plan }}</b> •Предоплаты: <b style="color:var(--gold)">{{ total_prepayment_plan|default:0 }} ₸</b>
<span class="text-muted">({{ prepay_count_plan }} записей)</span>

        </div>
      </div>

      <h5 class="mt-3 mb-2" style="color: var(--gold);">Топ услуг (план)</h5>
      {% if top_services_plan %}
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead>
            <tr>
              <th>Услуга</th>
              <th class="text-center">Записей</th>
              <th class="text-center">Сумма (оценка)</th>
            </tr>
          </thead>
          <tbody>
            {% for s in top_services_plan %}
            <tr>
              <td>{{ s.name }}</td>
              <td class="text-center fw-bold" style="color: var(--gold);">{{ s.bookings_count }}</td>
              <td class="text-center nowrap">{{ s.estimated_revenue }} ₸</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-muted mb-0">Нет данных за период.</p>
      {% endif %}

      <h5 class="mt-4 mb-2" style="color: var(--gold);">Загрузка мастеров (план)</h5>
      {% if master_stats_plan %}
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead>
            <tr>
              <th>Мастер</th>
              <th class="text-center">Записей</th>
              <th class="text-center">Занято (часов)</th>
            </tr>
          </thead>
          <tbody>
            {% for row in master_stats_plan %}
            <tr>
              <td>{{ row.master.full_name }}</td>
              <td class="text-center fw-bold" style="color: var(--gold);">{{ row.appointments_count }}</td>
              <td class="text-center nowrap">{{ row.total_hours }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <div class="text-muted" style="font-size:0.9rem;">
        План учитывает: new, confirmed, completed, no_show. Не учитывает: cancelled.
      </div>
    </div>

    <!-- B) ФАКТ -->
    <div class="card p-4" style="background: rgba(20,20,20,0.85); border: 1px solid rgba(255,215,0,0.25); border-radius: 18px;">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <h4 class="mb-0" style="color: var(--gold);">B) Факт выполнено (только completed)</h4>
        <div class="text-muted">
          Выполнено: <b style="color:#ddd">{{ total_fact }}</b> • Предоплаты: <b style="color:var(--gold)">{{ total_prepayment_fact|default:0 }} ₸</b>
<span class="text-muted">({{ prepay_count_fact }} записей)</span>
        </div>
      </div>

      <h5 class="mt-3 mb-2" style="color: var(--gold);">Топ услуг (факт)</h5>
      {% if top_services_fact %}
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead>
            <tr>
              <th>Услуга</th>
              <th class="text-center">Выполнено</th>
              <th class="text-center">Сумма (оценка)</th>
            </tr>
          </thead>
          <tbody>
            {% for s in top_services_fact %}
            <tr>
              <td>{{ s.name }}</td>
              <td class="text-center fw-bold" style="color: var(--gold);">{{ s.bookings_count }}</td>
              <td class="text-center">{{ s.estimated_revenue }} ₸</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-muted mb-0">Нет выполненных записей за период.</p>
      {% endif %}

      <h5 class="mt-4 mb-2" style="color: var(--gold);">Загрузка мастеров (факт)</h5>
      {% if master_stats_fact %}
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle">
          <thead>
            <tr>
              <th>Мастер</th>
              <th class="text-center">Выполнено</th>
              <th class="text-center">Часов (факт)</th>
            </tr>
          </thead>
          <tbody>
            {% for row in master_stats_fact %}
            <tr>
              <td>{{ row.master.full_name }}</td>
              <td class="text-center fw-bold" style="color: var(--gold);">{{ row.appointments_count }}</td>
              <td class="text-center">{{ row.total_hours }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <div class="text-muted" style="font-size:0.9rem;">
        Факт учитывает только записи со статусом: completed.
      </div>
    </div>

  </div>
</section>
{% endblock %}
