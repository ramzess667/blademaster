{% extends "base.html" %}
{% block title %}Отчёты — BladeMaster{% endblock %}

{% block content %}

<!-- Заголовок -->
<section class="py-5 text-center border-bottom border-secondary">
  <div class="container" data-aos="fade-down">
    <h1 class="display-5 fw-bold text-gold mb-2">Отчёты</h1>
    <p class="lead text-muted mb-0">Плановая нагрузка и факт выполненных записей за период</p>
  </div>
</section>

<section class="py-5">
  <div class="container">

    <!-- Фильтр дат -->
    <div class="card bg-dark border-0 shadow-lg rounded-4 overflow-hidden mb-4">
      <div class="card-body p-4 p-md-5">
        <form method="get" class="row g-3 align-items-end">
          <div class="col-12 col-md-4">
            <label class="text-muted fw-bold mb-2 d-block">С</label>
            <input type="date" name="from" value="{{ date_from|date:'Y-m-d' }}"
                   class="form-control form-control-lg bg-dark text-light border-gold">
          </div>

          <div class="col-12 col-md-4">
            <label class="text-muted fw-bold mb-2 d-block">По</label>
            <input type="date" name="to" value="{{ date_to|date:'Y-m-d' }}"
                   class="form-control form-control-lg bg-dark text-light border-gold">
          </div>

          <div class="col-12 col-md-4">
            <button class="btn btn-outline-gold btn-lg fw-bold rounded-pill w-100">
              Показать
            </button>
          </div>
        </form>

        <div class="text-muted mt-3" style="font-size: 0.95rem;">
          Период:
          <span class="text-light">{{ date_from|date:"d.m.Y" }}</span> —
          <span class="text-light">{{ date_to|date:"d.m.Y" }}</span>
        </div>
      </div>
    </div>

    <!-- Сводка по статусам -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-4 col-lg">
        <div class="card bg-dark border-0 shadow-lg rounded-4 h-100 text-center status-card">
          <div class="card-body p-3 p-md-4">
            <div class="text-muted small">Новые</div>
            <div class="fs-4 fw-bold text-gold">{{ counts.new }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-4 col-lg">
        <div class="card bg-dark border-0 shadow-lg rounded-4 h-100 text-center status-card">
          <div class="card-body p-3 p-md-4">
            <div class="text-muted small">Подтверждённые</div>
            <div class="fs-4 fw-bold text-gold">{{ counts.confirmed }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-4 col-lg">
        <div class="card bg-dark border-0 shadow-lg rounded-4 h-100 text-center status-card">
          <div class="card-body p-3 p-md-4">
            <div class="text-muted small">Выполненные</div>
            <div class="fs-4 fw-bold text-gold">{{ counts.completed }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-4 col-lg">
        <div class="card bg-dark border-0 shadow-lg rounded-4 h-100 text-center status-card">
          <div class="card-body p-3 p-md-4">
            <div class="text-muted small">Не пришёл</div>
            <div class="fs-4 fw-bold text-gold">{{ counts.no_show }}</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4 col-lg">
        <div class="card bg-dark border-0 shadow-lg rounded-4 h-100 text-center status-card">
          <div class="card-body p-3 p-md-4">
            <div class="text-muted small">Отменённые</div>
            <div class="fs-4 fw-bold text-gold">{{ counts.cancelled }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- A) ПЛАН -->
    <div class="card bg-dark border-0 shadow-lg rounded-4 overflow-hidden mb-4">
      <div class="card-body p-4 p-md-5">

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
          <h3 class="mb-0 text-gold fw-bold">A) Плановая нагрузка</h3>
          <div class="text-muted">
            Записей: <b class="text-light">{{ total_plan }}</b>
            <span class="mx-2">•</span>
            Предоплаты: <b class="text-gold">{{ total_prepayment_plan|default:0 }} ₸</b>
            <span class="text-muted">({{ prepay_count_plan }} записей)</span>
          </div>
        </div>

        <div class="text-muted mb-4" style="font-size: 0.95rem;">
          План учитывает: <span class="text-light">new, confirmed, completed, no_show</span>. Не учитывает: <span class="text-light">cancelled</span>.
        </div>

        <h5 class="text-gold fw-bold mt-3 mb-3">Топ услуг (план)</h5>
        {% if top_services_plan %}
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle mb-0">
              <thead>
                <tr>
                  <th>Услуга</th>
                  <th class="text-center">Записей</th>
                  <th class="text-center">Сумма (оценка)</th>
                </tr>
              </thead>
              <tbody>
                {% for s in top_services_plan %}
                  <tr>
                    <td>{{ s.name }}</td>
                    <td class="text-center fw-bold text-gold nowrap">{{ s.bookings_count }}</td>
                    <td class="text-center nowrap">{{ s.estimated_revenue }} ₸</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">Нет данных за период.</p>
        {% endif %}

        <h5 class="text-gold fw-bold mt-5 mb-3">Загрузка мастеров (план)</h5>
        {% if master_stats_plan %}
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle mb-0">
              <thead>
                <tr>
                  <th>Мастер</th>
                  <th class="text-center">Записей</th>
                  <th class="text-center">Занято (часов)</th>
                </tr>
              </thead>
              <tbody>
                {% for row in master_stats_plan %}
                  <tr>
                    <td>{{ row.master.full_name }}</td>
                    <td class="text-center fw-bold text-gold nowrap">{{ row.appointments_count }}</td>
                    <td class="text-center nowrap">{{ row.total_hours }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">Нет данных по мастерам за период.</p>
        {% endif %}
      </div>
    </div>

    <!-- B) ФАКТ -->
    <div class="card bg-dark border-0 shadow-lg rounded-4 overflow-hidden">
      <div class="card-body p-4 p-md-5">

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
          <h3 class="mb-0 text-gold fw-bold">B) Факт выполнено</h3>
          <div class="text-muted">
            Выполнено: <b class="text-light">{{ total_fact }}</b>
            <span class="mx-2">•</span>
            Предоплаты: <b class="text-gold">{{ total_prepayment_fact|default:0 }} ₸</b>
            <span class="text-muted">({{ prepay_count_fact }} записей)</span>
          </div>
        </div>

        <div class="text-muted mb-4" style="font-size: 0.95rem;">
          Факт учитывает только записи со статусом: <span class="text-light">completed</span>.
        </div>

        <h5 class="text-gold fw-bold mt-3 mb-3">Топ услуг (факт)</h5>
        {% if top_services_fact %}
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle mb-0">
              <thead>
                <tr>
                  <th>Услуга</th>
                  <th class="text-center">Выполнено</th>
                  <th class="text-center">Сумма (оценка)</th>
                </tr>
              </thead>
              <tbody>
                {% for s in top_services_fact %}
                  <tr>
                    <td>{{ s.name }}</td>
                    <td class="text-center fw-bold text-gold nowrap">{{ s.bookings_count }}</td>
                    <td class="text-center nowrap">{{ s.estimated_revenue }} ₸</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">Нет выполненных записей за период.</p>
        {% endif %}

        <h5 class="text-gold fw-bold mt-5 mb-3">Загрузка мастеров (факт)</h5>
        {% if master_stats_fact %}
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle mb-0">
              <thead>
                <tr>
                  <th>Мастер</th>
                  <th class="text-center">Выполнено</th>
                  <th class="text-center">Часов (факт)</th>
                </tr>
              </thead>
              <tbody>
                {% for row in master_stats_fact %}
                  <tr>
                    <td>{{ row.master.full_name }}</td>
                    <td class="text-center fw-bold text-gold nowrap">{{ row.appointments_count }}</td>
                    <td class="text-center nowrap">{{ row.total_hours }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">Нет данных по мастерам за период.</p>
        {% endif %}

      </div>
    </div>

  </div>
</section>

<style>
  .status-card { transition: transform .2s ease, box-shadow .2s ease; }
  .status-card:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(0,0,0,.35); }
  .nowrap { white-space: nowrap; }

  @media (max-width: 576px){
    .table thead th { font-size: .85rem; }
    .table td { font-size: .88rem; }
  }
</style>

{% endblock %}
